# qemu

## Creating a new VM

### Create a base image using the `base-image-builder.sh` script. 

`./base-image-builder.sh configs/debian-10.7.0-base.config`

This script will use `debian-10.7.0-base.config` as a point of reference for what installation media should be loaded 
into the new VM. You can create your own config for other distros by copying existing configs and modifying them for your 
own use.

### Install the OS as normal

Go through the normal process of installing the OS. Support for preseeding or kickstarting is not currently implemented, 
so for now you will need to install the OS manually (but only once). After that, you can terminate the `base-image-builder.sh` script.

**Note:** If you want virtual machines derived from your base to be accesible via OpenSSH, install and configure it now.

### Create a new virtual machine from a blueprint.

Blueprints are configuration files that describe how to use a base image to create other virtual machines. Either use the provided `debian-10.7.0-blueprint.config`,
or modify it to suit your own needs. Blueprints are read by the `create-new-blueprint.sh` script. 

Running `./create-new-blueprint.sh debian-10.7.0-blueprint.config`

Will take the `debian-10.7.0-blueprint.config` blueprint:

```
# The name of the existing base image you would like to build off of.
QEMU_BASE_IMG = ../base/img/debian-10.7.0-base.img

# The name of your new VM
QEMU_NAME = debian-10.7.0
```

and create a new folder called `debian-10.7.0`, which will contain a copy of base image `debian-10.7.0-base.img` you created earlier, and a new configuration file:

```
QEMU_NAME = debian-10.7.0

QEMU_IMG = debian-10.7.0.img

# Sets the SSH port of the server. You still need to configure OpenSSH.
SSH_PORT = 53010

# Sets the SPICE port for VNC-style remote access.
SPICE_PORT = 21008

# Sets the number of CPU cores the VM will use.
CORES = 4

# Set the RAM in megabytes of the VM.
MEMORY = 4096
```

Unlike a blueprint, which defines a re-usable "base", this new configuration is specific to an instantiation of a VM. This new configuration exists to prevent the need for manually entering in QEMU arguments in the command-line. You can run a new VM using this config:

`./up.sh debian-10.7.0/debian-10.7.0.config`

Under the hood, all this does is run the QEMU CLI, substituting in the variables from the configuration file, and setting up the pre-requisites for remote access via SPICE.

## Accessing a VM

Once a VM has been created, and is running with the `up.sh` script, you should see output similar to:

```
Starting VM debian-10.7.0 with 4096MB of RAM and 4 CPU cores. Connect over SPICE on 21008 or SSH on port 53010
```
These ports were chosen at random during the creation of your VM in the `create-new-from-blueprint.sh` script to reduce the chance of port conflicts. To adjust them, edit the configuration file generated by that script.

### Accessing via SSH

This is a bog-standard SSH connection. Remember, you would have needed to setup OpenSSH during the creation of your base image for it to already be setup. If you didn't but still want to, you could configure it now over the SPICE connection. 


### Accessing with SPICE

SPICE is similar to VNC, and QEMU supports it if your version of QEMU is compiled with SPICE support. You need a SPICE client, the most common one being `virt-viewer`. There are multiple ways of using it, I prefer the `remote-viewer` command it provides.

`remote-viewer spice://192.168.x.y?port=21008`

### Accessing with VNC
QEMU also supports VNC, but its capability is limited in that you can't seem to set your own VNC port, which is a problem if you want to run multiple QEMU VMs on the same host (and don't want to mess with networking).
